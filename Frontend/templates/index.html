<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Interactive Dataset Cleaner</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}"/>
</head>
<body>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="col-md-3 sidebar">
      <h5 class="text-light mb-3">üßπ Dataset Cleaner</h5>
      {% if columns %}

      <!-- NEW: Column Insights (numeric only) -->
      <div class="card">
        <div class="card-header">Column Insights (Numeric)</div>
        <div class="card-body p-2">
          <div class="mb-2">
            <label class="form-label">Numeric Column</label>
            <select id="numericColumnSelect" class="form-select form-select-sm"></select>
          </div>
          <div id="colStats" class="mb-2 small-mono"></div>
          <canvas id="histogramCanvas" height="120"></canvas>
        </div>
      </div>

      <!-- Fill Missing -->
      <div class="card">
        <div class="card-header">Fill Missing Values</div>
        <div class="card-body p-2">
          <form method="POST" action="/fill-missing">
            <div class="mb-2">
              <label class="form-label">Column</label>
              <select name="column" class="form-select form-select-sm">
                {% for col in columns %}<option>{{ col }}</option>{% endfor %}
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label">Method</label>
              <select name="method" class="form-select form-select-sm">
                <option value="mean">Mean</option>
                <option value="median">Median</option>
                <option value="mode">Mode</option>
                <option value="custom">Custom</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label">Custom Value (if custom)</label>
              <input type="text" name="custom_value" class="form-control form-control-sm" placeholder="e.g. 0 or Unknown"/>
            </div>
            <button class="btn btn-primary btn-sm w-100">Apply</button>
          </form>
        </div>
      </div>

      <!-- Row Ops -->
      <div class="card">
        <div class="card-header">Row Operations</div>
        <div class="card-body p-2 d-flex gap-2">
          <form method="POST" action="/drop-missing" class="w-50">
            <button class="btn btn-primary btn-sm w-100">Drop Missing</button>
          </form>
          <form method="POST" action="/remove-duplicates" class="w-50">
            <button class="btn btn-primary btn-sm w-100">Remove Duplicates</button>
          </form>
        </div>
      </div>

      <!-- Standardize Text -->
      <div class="card">
        <div class="card-header">Standardize Text Column</div>
        <div class="card-body p-2">
          <form method="POST" action="/standardize">
            <div class="mb-2">
              <label class="form-label">Column</label>
              <select name="column" class="form-select form-select-sm">
                {% for col in columns %}<option>{{ col }}</option>{% endfor %}
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label">Method</label>
              <select name="method" class="form-select form-select-sm">
                <option value="lowercase">Lowercase</option>
                <option value="uppercase">Uppercase</option>
                <option value="titlecase">Title Case</option>
                <option value="date">Date Format</option>
              </select>
            </div>
            <input type="hidden" name="decimal_places" value="2"/>
            <button class="btn btn-primary btn-sm w-100">Apply</button>
          </form>
        </div>
      </div>

      <!-- Round Numeric -->
      <div class="card">
        <div class="card-header">Round Numeric Column</div>
        <div class="card-body p-2">
          <form method="POST" action="/standardize">
            <div class="mb-2">
              <label class="form-label">Column</label>
              <select name="column" class="form-select form-select-sm">
                {% for col in columns %}<option>{{ col }}</option>{% endfor %}
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label">Decimal Places</label>
              <input type="number" name="decimal_places" class="form-control form-control-sm" value="2" min="0" max="10"/>
            </div>
            <input type="hidden" name="method" value="round"/>
            <button class="btn btn-primary btn-sm w-100">Round</button>
          </form>
        </div>
      </div>

      <!-- Outliers / Normalize -->
      <div class="card">
        <div class="card-header">Outliers / Normalize</div>
        <div class="card-body p-2">
          <div class="mb-2">
            <label class="form-label">Column</label>
          </div>
          <form method="POST" action="/remove-outliers" class="mb-2">
            <select name="column" class="form-select form-select-sm mb-2">
              {% for col in columns %}<option>{{ col }}</option>{% endfor %}
            </select>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" name="nonnegative_only" id="nonnegCheck">
              <label class="form-check-label" for="nonnegCheck">Enforce non-negative values</label>
            </div>
            <button class="btn btn-primary btn-sm w-100">Remove Outliers</button>
          </form>
          <form method="POST" action="/normalize">
            <select name="column" class="form-select form-select-sm mb-2">
              {% for col in columns %}<option>{{ col }}</option>{% endfor %}
            </select>
            <button class="btn btn-primary btn-sm w-100">Normalize</button>
          </form>
        </div>
      </div>

      <!-- One-Hot Encoding -->
      <div class="card">
        <div class="card-header">One-Hot Encoding</div>
        <div class="card-body p-2">
          <form method="POST" action="/one-hot-encoding">
            <label class="form-label">Columns (hold Cmd/Ctrl to multi-select)</label>
            <select name="columns" class="form-select form-select-sm mb-2" multiple>
              {% for col in columns %}<option>{{ col }}</option>{% endfor %}
            </select>
            <button class="btn btn-primary btn-sm w-100">Apply</button>
          </form>
        </div>
      </div>

      <!-- Linear Regression -->
      <div class="card">
        <div class="card-header">Linear Regression</div>
        <div class="card-body p-2">
          <form method="POST" action="/linear-regression">
            <label class="form-label">Feature 1</label>
            <select name="feature1" class="form-select form-select-sm mb-1">
              {% for col in columns %}<option>{{ col }}</option>{% endfor %}
            </select>
            <label class="form-label">Feature 2</label>
            <select name="feature2" class="form-select form-select-sm mb-1">
              {% for col in columns %}<option>{{ col }}</option>{% endfor %}
            </select>
            <label class="form-label">Target</label>
            <select name="target" class="form-select form-select-sm mb-1">
              {% for col in columns %}<option>{{ col }}</option>{% endfor %}
            </select>
            <label class="form-label">Predict (val1, val2)</label>
            <input type="text" name="predict_values" class="form-control form-control-sm mb-2" placeholder="e.g. 30, 70000"/>
            <button class="btn btn-primary btn-sm w-100">Train & Predict</button>
          </form>
        </div>
      </div>

      <!-- Polynomial Regression -->
      <div class="card">
        <div class="card-header">Polynomial Regression</div>
        <div class="card-body p-2">
          <form method="POST" action="/polynomial-regression">
            <label class="form-label">Feature 1</label>
            <select name="feature1" class="form-select form-select-sm mb-1">
              {% for col in columns %}<option>{{ col }}</option>{% endfor %}
            </select>
            <label class="form-label">Feature 2</label>
            <select name="feature2" class="form-select form-select-sm mb-1">
              {% for col in columns %}<option>{{ col }}</option>{% endfor %}
            </select>
            <label class="form-label">Target</label>
            <select name="target" class="form-select form-select-sm mb-1">
              {% for col in columns %}<option>{{ col }}</option>{% endfor %}
            </select>
            <label class="form-label">Degree</label>
            <input type="number" name="degree" class="form-control form-control-sm mb-1" value="2" min="1" max="5"/>
            <label class="form-label">Predict (val1, val2)</label>
            <input type="text" name="predict_values" class="form-control form-control-sm mb-2" placeholder="e.g. 30, 70000"/>
            <button class="btn btn-primary btn-sm w-100">Train & Predict</button>
          </form>
        </div>
      </div>

      <!-- KNN -->
      <div class="card">
        <div class="card-header">K-NN Classifier</div>
        <div class="card-body p-2">
          <form method="POST" action="/knn">
            <label class="form-label">Features (hold Cmd/Ctrl to multi-select)</label>
            <select name="feature_columns" class="form-select form-select-sm mb-1" multiple>
              {% for col in columns %}<option>{{ col }}</option>{% endfor %}
            </select>
            <label class="form-label">Target</label>
            <select name="target_column" class="form-select form-select-sm mb-1">
              {% for col in columns %}<option>{{ col }}</option>{% endfor %}
            </select>
            <label class="form-label">K Neighbours</label>
            <input type="number" name="k" class="form-control form-control-sm mb-1" value="3" min="1"/>
            <label class="form-label">Predict (comma-separated)</label>
            <input type="text" name="predict_values" class="form-control form-control-sm mb-2" placeholder="e.g. 30, 70000"/>
            <button class="btn btn-primary btn-sm w-100">Train & Predict</button>
          </form>
        </div>
      </div>

      <!-- NLP Query -->
      <div class="card">
        <div class="card-header">NLP Query</div>
        <div class="card-body p-2">
          <form method="POST" action="/nlp-query">
            <input type="text" name="query" class="form-control form-control-sm mb-2"
                   placeholder="e.g. fill missing Salary with median"/>
            <button class="btn btn-primary btn-sm w-100">Run</button>
          </form>
        </div>
      </div>

      <!-- Reset -->
      <form method="POST" action="/reset">
        <button class="btn btn-danger w-100">üîÑ Reset Session</button>
      </form>
      {% endif %}
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="col-md-9 main">
      <!-- Top bar -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="text-white">Interactive Dataset Cleaner</h1>
        {% if table %}
          <div class="d-flex gap-2 align-items-center">
            <span class="badge-shape">{{ table.shape[0] }} rows √ó {{ table.shape[1] }} cols</span>
            <a href="/download"><button class="btn btn-success btn-sm">‚¨á Download CSV</button></a>
          </div>
        {% endif %}
        <div>
          {% if session.get('user') %}
            <span class="me-2 small-mono">Signed in: {{ session.get('user') }} ({{ session.get('role') or 'user' }})</span>
            {% if session.get('role') == 'admin' %}
              <a href="/admin/dashboard" class="btn btn-info btn-sm me-2">üìä Admin Dashboard</a>
            {% endif %}
            <a href="/logout" class="btn btn-secondary btn-sm">Logout</a>
          {% else %}
            <a href="/login" class="btn btn-primary btn-sm">Sign in</a>
          {% endif %}
        </div>
      </div>

      <!-- Alerts -->
      {% if success %}
        <div class="alert alert-success py-2 px-3 alert-success-custom">
          ‚úÖ {{ success }}
        </div>
      {% endif %}
      {% if error %}
        <div class="alert alert-danger py-2 px-3 alert-danger-custom">
          ‚ùå {{ error }}
        </div>
      {% endif %}

      <!-- Prediction result -->
      {% if prediction is defined and prediction is not none %}
        <div class="alert py-2 px-3 mb-3 prediction-alert">
          üéØ Prediction: <strong>{{ prediction }}</strong>
          {% if r_squared is defined and r_squared is not none %}
            | R¬≤: <strong>{{ r_squared }}</strong>
          {% endif %}
        </div>
      {% endif %}

      <!-- Upload zone (no file loaded) -->
      {% if not table %}
        <div class="upload-zone mt-5">
          <form method="POST" action="/" enctype="multipart/form-data">
            <p class="text-secondary mb-3 upload-note">Upload a CSV, Excel or JSON file to get started</p>
            <input type="file" name="file" accept=".csv,.xlsx,.json" class="form-control form-control-sm mx-auto mb-3 upload-file-input"/>
            <button class="btn btn-primary">Upload File</button>
          </form>
        </div>
      {% else %}
        <!-- Dataset Table -->
        <div class="table-responsive table-scroll">
          <table class="table table-dark table-bordered table-hover table-sm">
            <thead class="sticky-top">
            <tr>
              {% for col in table.columns %}
                <th>{{ col }}</th>
              {% endfor %}
            </tr>
            </thead>
            <tbody>
            {% for row in table.data %}
              <tr>
                {% for col in table.columns %}
                  {% if row[col] is none %}
                    <td class="null-cell">None</td>
                  {% else %}
                    <td>{{ row[col] }}</td>
                  {% endif %}
                {% endfor %}
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  const API_BASE = 'http://localhost:8000';
  const SESSION_ID = '{{ session_id }}';
  let histChart = null;

  function setStats(summary) {
    const s = summary || {};
    const statsDiv = document.getElementById('colStats');
    const counts = s.counts || { total: 0, non_null: 0, nulls: 0, zeros: 0 };
    const st = s.stats || {};
    statsDiv.innerHTML = `
      <span class="stat-pill">Total: <strong>${counts.total}</strong></span>
      <span class="stat-pill">Non-null: <strong>${counts.non_null}</strong></span>
      <span class="stat-pill">Nulls: <strong>${counts.nulls}</strong></span>
      <span class="stat-pill">Zeros: <strong>${counts.zeros}</strong></span>
      ${s.numeric_like ?
        `<div class="mt-2">
           <span class="stat-pill">Min: <strong>${fmt(st.min)}</strong></span>
           <span class="stat-pill">Median: <strong>${fmt(st.median)}</strong></span>
           <span class="stat-pill">Mean: <strong>${fmt(st.mean)}</strong></span>
           <span class="stat-pill">Max: <strong>${fmt(st.max)}</strong></span>
         </div>` :
        `<div class="mt-2 text-warning small">Selected column is not numeric-like.</div>`
      }
    `;
  }

  function fmt(x){ return (x === undefined || x === null || Number.isNaN(x)) ? '‚Äî' : Number(x).toLocaleString(); }

  async function loadNumericColumns(){
    if(!SESSION_ID || !SESSION_ID.trim()) return;
    try {
      const res = await fetch(`${API_BASE}/policies/${SESSION_ID}`);
      if(!res.ok) {
        console.error('Failed to fetch policies:', res.status);
        return;
      }
      const pols = await res.json();
      const select = document.getElementById('numericColumnSelect');
      select.innerHTML = '';
      const numericCols = Object.keys(pols).filter(c => pols[c]?.numeric_like);
      for(const c of numericCols){
        const opt = document.createElement('option');
        opt.value = c; opt.textContent = c; select.appendChild(opt);
      }
      const saved = localStorage.getItem('selectedNumericColumn');
      if(saved && numericCols.includes(saved)){
        select.value = saved;
        fetchSummary(saved);
      } else if(numericCols.length > 0){
        select.value = numericCols[0];
        fetchSummary(numericCols[0]);
      }
      select.addEventListener('change', e => {
        const col = e.target.value;
        localStorage.setItem('selectedNumericColumn', col);
        fetchSummary(col);
      });
    } catch(err) {
      console.error('Error loading numeric columns:', err);
    }
  }

  async function fetchSummary(col){
    if(!SESSION_ID || !col) return;
    const res = await fetch(`${API_BASE}/column-summary`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ session_id: SESSION_ID, column: col, bins: 20 })
    });
    if(!res.ok){ return; }
    const summary = await res.json();
    setStats(summary);
    drawHistogram(summary.histogram, col);
  }

  function drawHistogram(hist, col){
    const ctx = document.getElementById('histogramCanvas').getContext('2d');
    const bins = hist?.bins || [];
    const counts = hist?.counts || [];
    const labels = [];
    for(let i=0;i<Math.max(0, bins.length-1);i++){
      const left = bins[i];
      const right = bins[i+1];
      labels.push(`${left.toFixed(0)}‚Äì${right.toFixed(0)}`);
    }
    if(histChart){ histChart.destroy(); }
    histChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{ label: `Distribution: ${col}`, data: counts, backgroundColor: '#5b6af0' }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { color: '#2a2d3a' }, ticks: { color: '#a0a8c0', autoSkip: true, maxRotation: 0 } },
          y: { grid: { color: '#2a2d3a' }, ticks: { color: '#a0a8c0' } }
        }
      }
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadNumericColumns();
    // After any full page reload (e.g., after removing outliers), restore the chart
    const savedCol = localStorage.getItem('selectedNumericColumn');
    if(savedCol){ fetchSummary(savedCol); }
  });
</script>
</body>
</html>
